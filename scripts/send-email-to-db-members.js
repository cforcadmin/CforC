/**
 * Script to send onboarding emails to transferred members
 *
 * This script:
 * 1. Reads magic-link-tokens.json generated by transfer-members-to-database.js
 * 2. Fetches member details from Strapi
 * 3. Sends personalized onboarding emails via Resend with magic links
 * 4. Tracks which emails were successfully sent
 *
 * Usage: node scripts/send-email-to-db-members.js
 */

const fs = require('fs')
const path = require('path')

// Load environment variables
require('dotenv').config({ path: '.env.local' })

const STRAPI_URL = process.env.STRAPI_URL
const STRAPI_API_TOKEN = process.env.STRAPI_API_TOKEN
const RESEND_API_KEY = process.env.RESEND_API_KEY

if (!STRAPI_URL || !STRAPI_API_TOKEN || !RESEND_API_KEY) {
  console.error('❌ Error: Missing required environment variables')
  console.error('   Required: STRAPI_URL, STRAPI_API_TOKEN, RESEND_API_KEY')
  process.exit(1)
}

// Send onboarding email using Resend
async function sendOnboardingEmail(email, name, magicLinkToken) {
  const magicLink = `https://www.cultureforchange.gr/auth/set-password?token=${magicLinkToken}`

  const emailHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #E8845C 0%, #D67355 100%); color: white; padding: 30px; border-radius: 8px 8px 0 0; text-align: center; }
    .content { background: #fff; padding: 30px; border: 1px solid #e0e0e0; border-top: none; }
    .button { display: inline-block; background: #E8845C; color: white; padding: 14px 28px; text-decoration: none; border-radius: 25px; font-weight: bold; margin: 20px 0; }
    .warning { background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 15px; margin: 20px 0; border-radius: 4px; }
    .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
    .note { background: #F3F4F6; padding: 15px; border-radius: 8px; margin: 15px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 style="margin: 0; font-size: 28px;">🎉 Καλώς ήρθες στη Νέα Ιστοσελίδα!</h1>
    </div>

    <div class="content">
      <p>Γεια σου${name && name !== 'Νέο Μέλος' ? ` ${name}` : ''}!</p>

      <p><strong>Σε προσκαλούμε να δοκιμάσεις τη νέα beta έκδοση της ιστοσελίδας Culture for Change!</strong></p>

      <p>Σου έχουμε δημιουργήσει έναν λογαριασμό για να μπορέσεις να δοκιμάσεις τις νέες λειτουργίες της ιστοσελίδας και να μας δώσεις το πολύτιμο feedback σου.</p>

      <div class="note">
        <p style="margin: 0;"><strong>🔑 Πρώτο βήμα: Ορισμός κωδικού πρόσβασης</strong></p>
        <p style="margin: 5px 0 0 0;">Κάνε κλικ στο παρακάτω κουμπί για να ορίσεις τον κωδικό σου:</p>
      </div>

      <div style="text-align: center;">
        <a href="${magicLink}" class="button">
          Ορισμός Κωδικού Πρόσβασης
        </a>
      </div>

      <div class="warning">
        <p style="margin: 0;"><strong>⚠️ Σημαντικό:</strong></p>
        <ul style="margin: 5px 0;">
          <li>Ο σύνδεσμος λήγει σε <strong>6 ώρες</strong></li>
          <li>Αν ο σύνδεσμος λήξει, μπορείς να ζητήσεις νέο <a href="https://www.cultureforchange.gr/login" style="color: #E8845C;">εδώ</a></li>
        </ul>
      </div>

      <h3>📝 Τι μπορείς να κάνεις;</h3>
      <ul>
        <li><strong>Επεξεργασία Προφίλ:</strong> Συμπλήρωσε τα στοιχεία σου (βιογραφικό, πεδία εργασίας, έργα, φωτογραφίες)</li>
        <li><strong>Δοκιμή Λειτουργιών:</strong> Εξερεύνησε τις νέες δυνατότητες της σελίδας</li>
        <li><strong>Feedback:</strong> Μοιράσου τις παρατηρήσεις σου για bugs ή βελτιώσεις</li>
      </ul>

      <h3>🎯 Γιατί το προφίλ μου είναι κενό;</h3>
      <p>Για λόγους ασφαλείας και προστασίας προσωπικών δεδομένων, δημιουργήσαμε το προφίλ σου με placeholder δεδομένα. Εσύ αποφασίζεις τι θέλεις να συμπληρώσεις και πόσο λεπτομερές θέλεις να είναι το προφίλ σου.</p>

      <div class="note">
        <p style="margin: 0;"><strong>🚀 Beta Testing Περίοδος: 10/12 - 6/1</strong></p>
        <p style="margin: 5px 0 0 0;">Η βοήθειά σου είναι πολύτιμη για να κάνουμε την ιστοσελίδα ακόμα καλύτερη!</p>
      </div>

      <p>Για οποιαδήποτε ερώτηση ή πρόβλημα, απάντησε σε αυτό το email.</p>

      <p style="margin-top: 30px;">Ευχαριστούμε για τη συμμετοχή σου! 🙌</p>
      <p><strong>Η ομάδα του Culture for Change</strong></p>
    </div>

    <div class="footer">
      <p>Culture for Change | Δίκτυο Κοινωνικής Καινοτομίας</p>
      <p>Αυτό το email στάλθηκε στη διεύθυνση ${email}</p>
    </div>
  </div>
</body>
</html>
`

  const emailText = `
Γεια σου${name && name !== 'Νέο Μέλος' ? ` ${name}` : ''}!

Σε προσκαλούμε να δοκιμάσεις τη νέα beta έκδοση της ιστοσελίδας Culture for Change!

Σου έχουμε δημιουργήσει έναν λογαριασμό για να μπορέσεις να δοκιμάσεις τις νέες λειτουργίες της ιστοσελίδας και να μας δώσεις το πολύτιμο feedback σου.

🔑 ΟΡΙΣΜΟΣ ΚΩΔΙΚΟΥ ΠΡΟΣΒΑΣΗΣ
Κάνε κλικ στον παρακάτω σύνδεσμο για να ορίσεις τον κωδικό σου:
${magicLink}

⚠️ ΣΗΜΑΝΤΙΚΟ:
- Ο σύνδεσμος λήγει σε 6 ώρες
- Αν ο σύνδεσμος λήξει, μπορείς να ζητήσεις νέο στη σελίδα σύνδεσης κάνοντας κλικ εδώ: https://www.cultureforchange.gr/login

📝 ΤΙ ΜΠΟΡΕΙΣ ΝΑ ΚΑΝΕΙΣ;
- Επεξεργασία Προφίλ: Συμπλήρωσε τα στοιχεία σου (βιογραφικό, πεδία εργασίας, έργα, φωτογραφίες)
- Δοκιμή Λειτουργιών: Εξερεύνησε τις νέες δυνατότητες της σελίδας
- Feedback: Μοιράσου τις παρατηρήσεις σου για bugs ή βελτιώσεις

🎯 ΓΙΑΤΙ ΤΟ ΠΡΟΦΙΛ ΜΟΥ ΕΙΝΑΙ ΚΕΝΟ;
Για λόγους ασφαλείας και προστασίας προσωπικών δεδομένων, δημιουργήσαμε το προφίλ σου με placeholder δεδομένα. Εσύ αποφασίζεις τι θέλεις να συμπληρώσεις και πόσο λεπτομερές θέλεις να είναι το προφίλ σου.

🚀 Beta Testing Περίοδος: 10/12 - 6/1
Η βοήθειά σου είναι πολύτιμη για να κάνουμε την ιστοσελίδα ακόμα καλύτερη!

Για οποιαδήποτε ερώτηση ή πρόβλημα, απάντησε σε αυτό το email.

Ευχαριστούμε για τη συμμετοχή σου! 🙌

Η ομάδα του Culture for Change
`

  const response = await fetch('https://api.resend.com/emails', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${RESEND_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      from: 'Culture for Change <noreply@cultureforchange.gr>',
      to: email,
      subject: '🎉 Καλωσόρισμα στη Νέα Beta Ιστοσελίδα - Ορισμός Κωδικού',
      html: emailHtml,
      text: emailText
    })
  })

  if (!response.ok) {
    const error = await response.json()
    throw new Error(`Resend error: ${error.message || response.statusText}`)
  }

  return await response.json()
}

// Fetch member details from Strapi
async function getMemberByEmail(email) {
  const response = await fetch(
    `${STRAPI_URL}/api/members?filters[Email][$eq]=${encodeURIComponent(email)}`,
    {
      headers: {
        'Authorization': `Bearer ${STRAPI_API_TOKEN}`
      }
    }
  )

  if (!response.ok) {
    throw new Error(`Failed to fetch member: ${response.statusText}`)
  }

  const data = await response.json()
  if (!data.data || data.data.length === 0) {
    throw new Error('Member not found')
  }

  return data.data[0]
}

// Main email sending function
async function sendEmailToMember(email, token) {
  console.log(`\n📧 Processing: ${email}`)

  try {
    // Fetch member details
    console.log('   Fetching member details...')
    const member = await getMemberByEmail(email)
    console.log(`   ✅ Member found: ${member.Name}`)

    // Send onboarding email
    console.log('   Sending onboarding email...')
    await sendOnboardingEmail(email, member.Name, token)
    console.log('   ✅ Email sent successfully!')

    return { success: true, email }

  } catch (error) {
    console.error(`   ❌ Failed: ${error.message}`)
    return { success: false, email, error: error.message }
  }
}

// Main execution
async function main() {
  const tokensPath = path.resolve(__dirname, 'magic-link-tokens.json')

  if (!fs.existsSync(tokensPath)) {
    console.error(`❌ Error: File not found: ${tokensPath}`)
    console.error('   Please run transfer-members-to-database.js first')
    process.exit(1)
  }

  const tokensData = JSON.parse(fs.readFileSync(tokensPath, 'utf8'))

  if (!tokensData || tokensData.length === 0) {
    console.error('❌ Error: No tokens found in magic-link-tokens.json')
    process.exit(1)
  }

  console.log(`🚀 Starting email sending process...`)
  console.log(`📊 Total emails to send: ${tokensData.length}\n`)

  const results = []

  for (const { email, token } of tokensData) {
    const result = await sendEmailToMember(email, token)
    results.push(result)

    // Small delay to avoid rate limiting
    await new Promise(resolve => setTimeout(resolve, 1000))
  }

  // Summary
  const successful = results.filter(r => r.success).length
  const failed = results.filter(r => !r.success).length

  console.log('\n' + '='.repeat(60))
  console.log('📊 EMAIL SENDING SUMMARY')
  console.log('='.repeat(60))
  console.log(`✅ Successfully sent: ${successful}`)
  console.log(`❌ Failed: ${failed}`)

  if (failed > 0) {
    console.log('\n❌ Failed emails:')
    results.filter(r => !r.success).forEach(r => {
      console.log(`   - ${r.email}: ${r.error}`)
    })
  }

  console.log('\n✨ Email sending process complete!')
}

// Run the script
main().catch(error => {
  console.error('\n❌ Fatal error:', error)
  process.exit(1)
})
