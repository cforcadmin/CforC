/**
 * DRY RUN: Detect cities/provinces in FieldsOfWork and export CSV report.
 *
 * This script does NOT modify the database. It produces a CSV so you can
 * review every proposed change before running the upload script.
 *
 * Usage:
 *   node scripts/clean-fields-of-work-dry-run.js
 *
 * Output:
 *   fields-of-work-cleanup-report-<date>.csv
 */

const fs = require('fs')
const path = require('path')
require('dotenv').config({ path: '.env.local' })

const STRAPI_URL = process.env.STRAPI_URL
const STRAPI_API_TOKEN = process.env.STRAPI_API_TOKEN

if (!STRAPI_URL || !STRAPI_API_TOKEN) {
  console.error('‚ùå STRAPI_URL and STRAPI_API_TOKEN must be set in .env.local')
  process.exit(1)
}

// ‚îÄ‚îÄ‚îÄ City ‚Üí Province map (mirrors lib/greekCities.ts) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CITY_TO_PROVINCE = {
  "ŒëŒ∏ŒÆŒΩŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ†ŒµŒπœÅŒ±ŒπŒ¨œÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ†ŒµœÅŒπœÉœÑŒ≠œÅŒπ": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒöŒ±ŒªŒªŒπŒ∏Œ≠Œ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒùŒØŒ∫Œ±ŒπŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒìŒªœÖœÜŒ¨Œ¥Œ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒëŒπŒ≥Œ¨ŒªŒµœâ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒùŒ≠Œ± Œ£ŒºœçœÅŒΩŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒäŒªŒπŒøŒΩ": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒëŒ≥ŒØŒ± Œ†Œ±œÅŒ±œÉŒ∫ŒµœÖŒÆ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒßŒ±ŒªŒ¨ŒΩŒ¥œÅŒπ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒúŒ±œÅŒøœçœÉŒπ": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒöŒ∑œÜŒπœÉŒπŒ¨": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒóŒªŒπŒøœçœÄŒøŒªŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒëœÅŒ≥œÖœÅŒøœçœÄŒøŒªŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒíŒøœçŒªŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒíŒøœÖŒªŒπŒ±Œ≥ŒºŒ≠ŒΩŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ°Œ±œÜŒÆŒΩŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒõŒ±œçœÅŒπŒø": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒúŒ≠Œ≥Œ±œÅŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒïŒªŒµœÖœÉŒØŒΩŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "Œ£Œ±ŒªŒ±ŒºŒØŒΩŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒëŒØŒ≥ŒπŒΩŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ†œåœÅŒøœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒéŒ¥œÅŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ£œÄŒ≠œÑœÉŒµœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ†Œ±ŒªŒªŒÆŒΩŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒìŒ≠œÅŒ±Œ∫Œ±œÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒöŒøœÅœâœÄŒØ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒíŒ¨œÅŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒùŒ≠Œ± ŒôœâŒΩŒØŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒóœÅŒ¨Œ∫ŒªŒµŒπŒø ŒëœÑœÑŒπŒ∫ŒÆœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒúŒµœÑŒ±ŒºœåœÅœÜœâœÉŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒõœÖŒ∫œåŒ≤œÅœÖœÉŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ†ŒµŒΩœÑŒ≠ŒªŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "Œ†Œ±œÄŒ¨Œ≥ŒøœÖ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒßŒøŒªŒ±œÅŒ≥œåœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒíœÅŒπŒªŒÆœÉœÉŒπŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "Œ¶ŒπŒªŒøŒ∏Œ≠Œ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ®œÖœáŒπŒ∫œå": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒïŒ∫Œ¨ŒªŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒîŒ¨œÜŒΩŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ•ŒºŒ∑œÑœÑœåœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒÜŒªŒπŒºŒøœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒïŒªŒªŒ∑ŒΩŒπŒ∫œå": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒëœÅœÑŒ≠ŒºŒπŒ¥Œ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ£œÄŒ¨œÑŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒúŒ±œÅŒ∫œåœÄŒøœÖŒªŒø": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒöŒµœÅŒ±œÑœÉŒØŒΩŒπ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒîœÅŒ±œÄŒµœÑœÉœéŒΩŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒúŒøœÉœáŒ¨œÑŒø": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "Œ§Œ±œçœÅŒøœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒöŒøœÅœÖŒ¥Œ±ŒªŒªœåœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "Œ†ŒµœÑœÅŒøœçœÄŒøŒªŒ∑": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒÜŒΩœâ ŒõŒπœåœÉŒπŒ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒñŒµœÜœçœÅŒπ": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒëœáŒ±œÅŒΩŒ≠œÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒòœÅŒ±Œ∫ŒøŒºŒ±Œ∫ŒµŒ¥œåŒΩŒµœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒîŒπœåŒΩœÖœÉŒøœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒëŒΩŒ¨Œ≤œÖœÉœÉŒøœÇ": ["ŒëœÑœÑŒπŒ∫ŒÆ"], "ŒöŒµœÅŒ±œÑŒ≠Œ±": ["ŒëœÑœÑŒπŒ∫ŒÆ"],
  "ŒòŒµœÉœÉŒ±ŒªŒøŒΩŒØŒ∫Œ∑": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "ŒöŒ±ŒªŒ±ŒºŒ±œÅŒπŒ¨": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "Œ£Œ≠œÅœÅŒµœÇ": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "ŒöŒ±œÑŒµœÅŒØŒΩŒ∑": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒíŒ≠œÅŒøŒπŒ±": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "ŒùŒ¨ŒøœÖœÉŒ±": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒàŒ¥ŒµœÉœÉŒ±": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "ŒìŒπŒ±ŒΩŒΩŒπœÑœÉŒ¨": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒöŒπŒªŒ∫ŒØœÇ": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "Œ†ŒøŒªœçŒ≥œÖœÅŒøœÇ": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒßŒ±ŒªŒ∫ŒπŒ¥ŒπŒ∫ŒÆ": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "ŒùŒ≠Œ± ŒúŒøœÖŒ¥Œ±ŒΩŒπŒ¨": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒöŒ±œÉœÉŒ¨ŒΩŒ¥œÅŒ±": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "ŒõŒπœÑœåœáœâœÅŒø": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒëŒªŒµŒæŒ¨ŒΩŒ¥œÅŒµŒπŒ±": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "Œ£Œ∫œçŒ¥œÅŒ±": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "Œ£œÑŒ±œÖœÅŒøœçœÄŒøŒªŒ∑": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "ŒïœçŒøœÉŒºŒøœÇ": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒëŒºœÄŒµŒªœåŒ∫Œ∑œÄŒøŒπ": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "Œ†œÖŒªŒ±ŒØŒ±": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒòŒ≠œÅŒºŒ∑": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "Œ©œÅŒ±ŒπœåŒ∫Œ±œÉœÑœÅŒø": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "Œ†ŒµœÅŒ±ŒØŒ±": ["ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒöŒøŒ∂Œ¨ŒΩŒ∑": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "Œ†œÑŒøŒªŒµŒºŒ±ŒêŒ¥Œ±": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "Œ¶ŒªœéœÅŒπŒΩŒ±": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "ŒöŒ±œÉœÑŒøœÅŒπŒ¨": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒìœÅŒµŒ≤ŒµŒΩŒ¨": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"], "Œ£ŒπŒ¨œÑŒπœÉœÑŒ±": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒëŒºœçŒΩœÑŒ±ŒπŒø": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±"],
  "ŒöŒ±Œ≤Œ¨ŒªŒ±": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "ŒöŒøŒºŒøœÑŒ∑ŒΩŒÆ": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "ŒûŒ¨ŒΩŒ∏Œ∑": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "ŒëŒªŒµŒæŒ±ŒΩŒ¥œÅŒøœçœÄŒøŒªŒ∑": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "ŒîœÅŒ¨ŒºŒ±": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "ŒüœÅŒµœÉœÑŒπŒ¨Œ¥Œ±": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "ŒîŒπŒ¥œÖŒºœåœÑŒµŒπœáŒø": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "Œ£ŒøœÖœÜŒªŒØ": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "ŒòŒ¨œÉŒøœÇ": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "ŒßœÅœÖœÉŒøœçœÄŒøŒªŒ∑": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "ŒïŒªŒµœÖŒ∏ŒµœÅŒøœçœÄŒøŒªŒ∑": ["ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑"],
  "ŒôœâŒ¨ŒΩŒΩŒπŒΩŒ±": ["ŒâœÄŒµŒπœÅŒøœÇ"], "ŒÜœÅœÑŒ±": ["ŒâœÄŒµŒπœÅŒøœÇ"], "Œ†œÅŒ≠Œ≤ŒµŒ∂Œ±": ["ŒâœÄŒµŒπœÅŒøœÇ"],
  "ŒóŒ≥ŒøœÖŒºŒµŒΩŒØœÑœÉŒ±": ["ŒâœÄŒµŒπœÅŒøœÇ"], "ŒöœåŒΩŒπœÑœÉŒ±": ["ŒâœÄŒµŒπœÅŒøœÇ"], "ŒúŒ≠œÑœÉŒøŒ≤Œø": ["ŒâœÄŒµŒπœÅŒøœÇ"],
  "Œ¶ŒπŒªŒπŒ¨œÑŒµœÇ": ["ŒâœÄŒµŒπœÅŒøœÇ"], "Œ†Œ¨œÅŒ≥Œ±": ["ŒâœÄŒµŒπœÅŒøœÇ"],
  "ŒõŒ¨œÅŒπœÉŒ±": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"], "ŒíœåŒªŒøœÇ": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"], "Œ§œÅŒØŒ∫Œ±ŒªŒ±": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"],
  "ŒöŒ±œÅŒ¥ŒØœÑœÉŒ±": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"], "ŒùŒ≠Œ± ŒôœâŒΩŒØŒ± ŒíœåŒªŒøœÖ": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"],
  "Œ£Œ∫ŒπŒ¨Œ∏ŒøœÇ": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"], "Œ£Œ∫œåœÄŒµŒªŒøœÇ": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"], "ŒëŒªœåŒΩŒΩŒ∑œÉŒøœÇ": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"],
  "ŒïŒªŒ±œÉœÉœåŒΩŒ±": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"], "Œ§œçœÅŒΩŒ±Œ≤ŒøœÇ": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"], "Œ¶Œ¨œÅœÉŒ±ŒªŒ±": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"],
  "ŒöŒ±ŒªŒ±ŒºœÄŒ¨Œ∫Œ±": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"], "Œ†Œ±ŒªŒ±ŒºŒ¨œÇ": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"], "Œ£ŒøœÜŒ¨Œ¥ŒµœÇ": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"],
  "ŒëŒªŒºœÖœÅœåœÇ": ["ŒòŒµœÉœÉŒ±ŒªŒØŒ±"],
  "ŒõŒ±ŒºŒØŒ±": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒßŒ±ŒªŒ∫ŒØŒ¥Œ±": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒòŒÆŒ≤Œ±": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒõŒπŒ≤Œ±Œ¥ŒµŒπŒ¨": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒÜŒºœÜŒπœÉœÉŒ±": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒöŒ±œÅœÄŒµŒΩŒÆœÉŒπ": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒëœÅŒ¨œáœâŒ≤Œ±": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒîŒµŒªœÜŒøŒØ": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒôœÑŒ≠Œ±": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒìŒ±ŒªŒ±ŒæŒØŒ¥Œπ": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒïœÅŒ≠œÑœÅŒπŒ±": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒëŒπŒ¥Œ∑œàœåœÇ": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒôœÉœÑŒπŒ±ŒØŒ±": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒöœçŒºŒ∑": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒëœÑŒ±ŒªŒ¨ŒΩœÑŒ∑": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"], "Œ£œÑœÖŒªŒØŒ¥Œ±": ["Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "Œ†Œ¨œÑœÅŒ±": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒëŒ≥œÅŒØŒΩŒπŒø": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒúŒµœÉŒøŒªœåŒ≥Œ≥Œπ": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"], "Œ†œçœÅŒ≥ŒøœÇ": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒëŒºŒ±ŒªŒπŒ¨Œ¥Œ±": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒùŒ±œçœÄŒ±Œ∫œÑŒøœÇ": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒëŒØŒ≥ŒπŒø": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒöŒ¨œÑœâ ŒëœáŒ±ŒêŒ±": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒüŒªœÖŒºœÄŒØŒ±": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒöœÅŒ≠œÉœÑŒµŒΩŒ±": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "ŒõŒµœáŒ±ŒπŒΩŒ¨": ["ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"],
  "Œ§œÅŒØœÄŒøŒªŒ∑": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"], "ŒöŒ±ŒªŒ±ŒºŒ¨œÑŒ±": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"],
  "ŒöœåœÅŒπŒΩŒ∏ŒøœÇ": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"], "Œ£œÄŒ¨œÅœÑŒ∑": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"],
  "ŒùŒ±œçœÄŒªŒπŒø": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"], "ŒÜœÅŒ≥ŒøœÇ": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"],
  "ŒúŒµŒ≥Œ±ŒªœåœÄŒøŒªŒ∑": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"], "ŒìœçŒ∏ŒµŒπŒø": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"],
  "ŒúŒøŒΩŒµŒºŒ≤Œ±œÉŒπŒ¨": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"], "ŒöŒπŒ¨œÑŒø": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"],
  "ŒûœÖŒªœåŒ∫Œ±œÉœÑœÅŒø": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"], "ŒõŒøœÖœÑœÅŒ¨Œ∫Œπ": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"],
  "ŒùŒµŒºŒ≠Œ±": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"], "ŒïœÄŒØŒ¥Œ±œÖœÅŒøœÇ": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"],
  "ŒúœÖœÉœÑœÅŒ¨œÇ": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"], "Œ†œçŒªŒøœÇ": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"],
  "ŒúŒµŒ∏œéŒΩŒ∑": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"], "ŒöœÖœÄŒ±œÅŒπœÉœÉŒØŒ±": ["Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ"],
  "ŒöŒ≠œÅŒ∫œÖœÅŒ±": ["ŒôœåŒΩŒπŒ± ŒùŒ∑œÉŒπŒ¨"], "ŒõŒµœÖŒ∫Œ¨Œ¥Œ±": ["ŒôœåŒΩŒπŒ± ŒùŒ∑œÉŒπŒ¨"],
  "ŒëœÅŒ≥ŒøœÉœÑœåŒªŒπ": ["ŒôœåŒΩŒπŒ± ŒùŒ∑œÉŒπŒ¨"], "ŒöŒµœÜŒ±ŒªŒøŒΩŒπŒ¨": ["ŒôœåŒΩŒπŒ± ŒùŒ∑œÉŒπŒ¨"],
  "ŒñŒ¨Œ∫œÖŒΩŒ∏ŒøœÇ": ["ŒôœåŒΩŒπŒ± ŒùŒ∑œÉŒπŒ¨", "ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±"], "ŒôŒ∏Œ¨Œ∫Œ∑": ["ŒôœåŒΩŒπŒ± ŒùŒ∑œÉŒπŒ¨"],
  "Œ†Œ±ŒæŒøŒØ": ["ŒôœåŒΩŒπŒ± ŒùŒ∑œÉŒπŒ¨"], "ŒöœçŒ∏Œ∑œÅŒ±": ["ŒôœåŒΩŒπŒ± ŒùŒ∑œÉŒπŒ¨"],
  "ŒúœÖœÑŒπŒªŒÆŒΩŒ∑": ["ŒíœåœÅŒµŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒõŒ≠œÉŒ≤ŒøœÇ": ["ŒíœåœÅŒµŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒßŒØŒøœÇ": ["ŒíœåœÅŒµŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "Œ£Œ¨ŒºŒøœÇ": ["ŒíœåœÅŒµŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒõŒÆŒºŒΩŒøœÇ": ["ŒíœåœÅŒµŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒúœçœÅŒπŒΩŒ±": ["ŒíœåœÅŒµŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒôŒ∫Œ±œÅŒØŒ±": ["ŒíœåœÅŒµŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒÜŒ≥ŒπŒøœÇ ŒöŒÆœÅœÖŒ∫ŒøœÇ": ["ŒíœåœÅŒµŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒïœÅŒºŒøœçœÄŒøŒªŒ∑": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "Œ£œçœÅŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "Œ°œåŒ¥ŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒöœâœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒúœçŒ∫ŒøŒΩŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "Œ£Œ±ŒΩœÑŒøœÅŒØŒΩŒ∑": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒòŒÆœÅŒ±": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒùŒ¨ŒæŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "Œ†Œ¨œÅŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒëŒΩœÑŒØœÄŒ±œÅŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "Œ§ŒÆŒΩŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒÜŒΩŒ¥œÅŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒúŒÆŒªŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "Œ£ŒØœÜŒΩŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "Œ£Œ≠œÅŒπœÜŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒöœçŒ∏ŒΩŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒöŒ≠Œ±": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒëŒºŒøœÅŒ≥œåœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒäŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "Œ¶ŒøŒªŒ≠Œ≥Œ±ŒΩŒ¥œÅŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "Œ£ŒØŒ∫ŒπŒΩŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "Œ†Œ¨œÑŒºŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒõŒ≠œÅŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒöŒ¨ŒªœÖŒºŒΩŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒëœÉœÑœÖœÄŒ¨ŒªŒ±ŒπŒ±": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒöŒ¨œÅœÄŒ±Œ∏ŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒöŒ¨œÉŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "Œ£œçŒºŒ∑": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "Œ§ŒÆŒªŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"], "ŒùŒØœÉœÖœÅŒøœÇ": ["ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø"],
  "ŒóœÅŒ¨Œ∫ŒªŒµŒπŒø": ["ŒöœÅŒÆœÑŒ∑"], "ŒßŒ±ŒΩŒπŒ¨": ["ŒöœÅŒÆœÑŒ∑"], "Œ°Œ≠Œ∏œÖŒºŒΩŒø": ["ŒöœÅŒÆœÑŒ∑"],
  "ŒÜŒ≥ŒπŒøœÇ ŒùŒπŒ∫œåŒªŒ±ŒøœÇ": ["ŒöœÅŒÆœÑŒ∑"], "ŒôŒµœÅŒ¨œÄŒµœÑœÅŒ±": ["ŒöœÅŒÆœÑŒ∑"], "Œ£Œ∑œÑŒµŒØŒ±": ["ŒöœÅŒÆœÑŒ∑"],
  "ŒúŒøŒØœÅŒµœÇ": ["ŒöœÅŒÆœÑŒ∑"], "Œ§œÖŒºœÄŒ¨Œ∫Œπ": ["ŒöœÅŒÆœÑŒ∑"], "ŒöŒØœÉœÉŒ±ŒºŒøœÇ": ["ŒöœÅŒÆœÑŒ∑"],
  "ŒëŒΩœéŒ≥ŒµŒπŒ±": ["ŒöœÅŒÆœÑŒ∑"], "ŒëœÅŒ∫Œ±ŒªŒøœáœéœÅŒπ": ["ŒöœÅŒÆœÑŒ∑"], "ŒùŒµŒ¨œÄŒøŒªŒ∑ ŒöœÅŒÆœÑŒ∑œÇ": ["ŒöœÅŒÆœÑŒ∑"],
}

// All province names (for detecting provinces in FieldsOfWork)
const ALL_PROVINCES = [
  "ŒëœÑœÑŒπŒ∫ŒÆ", "ŒöŒµŒΩœÑœÅŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±", "ŒîœÖœÑŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ±",
  "ŒëŒΩŒ±œÑŒøŒªŒπŒ∫ŒÆ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒØŒ± Œ∫Œ±Œπ ŒòœÅŒ¨Œ∫Œ∑", "ŒâœÄŒµŒπœÅŒøœÇ", "ŒòŒµœÉœÉŒ±ŒªŒØŒ±",
  "Œ£œÑŒµœÅŒµŒ¨ ŒïŒªŒªŒ¨Œ¥Œ±", "ŒîœÖœÑŒπŒ∫ŒÆ ŒïŒªŒªŒ¨Œ¥Œ±", "Œ†ŒµŒªŒøœÄœåŒΩŒΩŒ∑œÉŒøœÇ",
  "ŒôœåŒΩŒπŒ± ŒùŒ∑œÉŒπŒ¨", "ŒíœåœÅŒµŒπŒø ŒëŒπŒ≥Œ±ŒØŒø", "ŒùœåœÑŒπŒø ŒëŒπŒ≥Œ±ŒØŒø", "ŒöœÅŒÆœÑŒ∑",
]

// All city names
const ALL_CITIES = Object.keys(CITY_TO_PROVINCE)

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/** Strip accents / diacritics for fuzzy matching. */
function normalizeGreek(text) {
  return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase()
}

/** Build a lookup map { normalised_name ‚Üí canonical_name } */
function buildLookup(names) {
  const map = {}
  for (const name of names) {
    map[normalizeGreek(name)] = name
  }
  return map
}

const cityLookup = buildLookup(ALL_CITIES)
const provinceLookup = buildLookup(ALL_PROVINCES)

function escapeCsvValue(value) {
  if (value === null || value === undefined) return ''
  const s = String(value)
  if (s.includes(',') || s.includes('"') || s.includes('\n')) {
    return `"${s.replace(/"/g, '""')}"`
  }
  return s
}

// ‚îÄ‚îÄ‚îÄ Core logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Analyse one member's FieldsOfWork.
 * Returns { detectedCities, detectedProvinces, cleanedFields, newCity, newProvince }
 */
function analyseMember(member) {
  const originalFoW = member.FieldsOfWork || ''
  const originalCity = member.City || ''
  const originalProvince = member.Province || ''

  // Split FieldsOfWork entries
  const fowEntries = originalFoW.split(',').map(e => e.trim()).filter(e => e && e !== '-')

  const detectedCities = []      // canonical city names found in FoW
  const detectedProvinces = []   // canonical province names found in FoW
  const cleanedEntries = []      // FoW entries that are NOT cities/provinces

  for (const entry of fowEntries) {
    const norm = normalizeGreek(entry)

    if (cityLookup[norm]) {
      detectedCities.push(cityLookup[norm])
    } else if (provinceLookup[norm]) {
      detectedProvinces.push(provinceLookup[norm])
    } else {
      cleanedEntries.push(entry)
    }
  }

  // Merge detected cities with existing City field
  const existingCities = originalCity
    .split(',').map(c => c.trim()).filter(c => c && c !== '-')
  const allCities = [...new Set([...existingCities, ...detectedCities])]

  // Derive provinces from ALL cities (existing + detected)
  const derivedProvinces = new Set()
  for (const city of allCities) {
    const provs = CITY_TO_PROVINCE[city]
    if (provs) provs.forEach(p => derivedProvinces.add(p))
  }
  // Also add any provinces that were explicitly detected in FoW
  for (const prov of detectedProvinces) {
    derivedProvinces.add(prov)
  }
  // Also keep any existing provinces that aren't empty
  const existingProvinces = originalProvince
    .split(',').map(p => p.trim()).filter(p => p && p !== '-')
  for (const p of existingProvinces) {
    derivedProvinces.add(p)
  }

  const newCity = allCities.join(', ')
  const newProvince = Array.from(derivedProvinces).join(', ')
  const newFoW = cleanedEntries.join(', ')

  const changed = (newFoW !== originalFoW) || (newCity !== originalCity) || (newProvince !== originalProvince)

  return {
    detectedCities,
    detectedProvinces,
    cleanedFields: newFoW,
    newCity,
    newProvince,
    changed,
  }
}

// ‚îÄ‚îÄ‚îÄ Fetch members ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchAllMembers() {
  console.log('üì° Fetching members from Strapi...')
  let all = []
  let page = 1
  const pageSize = 100
  let hasMore = true

  while (hasMore) {
    const url = `${STRAPI_URL}/api/members?pagination[page]=${page}&pagination[pageSize]=${pageSize}&fields[0]=Name&fields[1]=FieldsOfWork&fields[2]=City&fields[3]=Province`
    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${STRAPI_API_TOKEN}` },
    })
    if (!res.ok) throw new Error(`Strapi ${res.status}: ${res.statusText}`)
    const data = await res.json()
    if (data.data && data.data.length > 0) {
      all = all.concat(data.data)
      console.log(`   Page ${page}: ${data.data.length} members (total ${all.length})`)
    }
    hasMore = data.meta?.pagination ? page < data.meta.pagination.pageCount : false
    page++
  }
  console.log(`‚úÖ Fetched ${all.length} members\n`)
  return all
}

// ‚îÄ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function main() {
  console.log('üîç Fields-of-Work Cleanup ‚Äî DRY RUN\n')

  const members = await fetchAllMembers()
  if (members.length === 0) { console.log('No members found.'); return }

  const headers = [
    'ID', 'Document ID', 'Name',
    'Original FieldsOfWork', 'Original City', 'Original Province',
    'Detected Cities in FoW', 'Detected Provinces in FoW',
    'New FieldsOfWork', 'New City', 'New Province',
    'Changed',
  ]

  const rows = []
  let changedCount = 0

  for (const m of members) {
    const result = analyseMember(m)
    if (result.changed) changedCount++

    rows.push([
      m.id,
      m.documentId,
      m.Name,
      m.FieldsOfWork || '',
      m.City || '',
      m.Province || '',
      result.detectedCities.join(', '),
      result.detectedProvinces.join(', '),
      result.cleanedFields,
      result.newCity,
      result.newProvince,
      result.changed ? 'YES' : '',
    ])
  }

  // Build CSV
  const csvLines = [
    headers.map(escapeCsvValue).join(','),
    ...rows.map(row => row.map(escapeCsvValue).join(',')),
  ]

  const timestamp = new Date().toISOString().split('T')[0]
  const filename = `fields-of-work-cleanup-report-${timestamp}.csv`
  const filepath = path.join(process.cwd(), filename)

  fs.writeFileSync(filepath, '\uFEFF' + csvLines.join('\n'), 'utf8') // BOM for Excel Greek support

  console.log(`üìä Total members: ${members.length}`)
  console.log(`üîÑ Members with changes: ${changedCount}`)
  console.log(`üìÅ Report saved: ${filename}`)

  // Also print a summary of affected members to console
  if (changedCount > 0) {
    console.log('\n‚îÄ‚îÄ Affected members ‚îÄ‚îÄ')
    for (const row of rows) {
      if (row[11] === 'YES') {
        const name = row[2]
        const detCities = row[6]
        const detProvs = row[7]
        const parts = []
        if (detCities) parts.push(`cities: [${detCities}]`)
        if (detProvs) parts.push(`provinces: [${detProvs}]`)
        const found = parts.length > 0 ? parts.join(', ') : 'field/province cleanup only'
        console.log(`   ‚Ä¢ ${name} ‚Äî ${found}`)
      }
    }
  }

  console.log('\n‚úÖ Done. Review the CSV, then run clean-fields-of-work-upload.js to apply changes.')
}

main().catch(err => { console.error('‚ùå', err.message); process.exit(1) })
